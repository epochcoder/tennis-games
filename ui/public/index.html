<!doctype html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8">
        <title>Tennis Games</title>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <link rel="stylesheet" href="css/bootstrap-reboot.min.css">
        <link rel="stylesheet" href="css/bootstrap.min.css">

        <style type="text/css">

            span.group-a {
                color: deepskyblue;
            }

            span.group-b {
                color: indianred;
            }

        </style>

        <script type="text/javascript " src="js/vue.min.js"></script>
        <script type="text/javascript">

            const PROD = false;
            window.addEventListener('load', function () {
                Vue.component('match-player', {
                    props: ['player'],
                    computed: {
                        classObject: function () {
                            return {
                                'group-a': this.player['group'] === 'A',
                                'group-b': this.player['group'] === 'B'
                            }
                        },
                        playerName: function () {
                            return this.player.name.charAt(0).toUpperCase() + this.player.name.slice(1);
                        }
                    },
                    template: '<span v-bind:class="classObject">{{ playerName }}</span>'
                });
                Vue.component('match-team', {
                    props: ['team'],
                    template: `
                        <li class="team list-group-item">
                            <match-player v-bind:player="team.playerA"/>
                            <span>/</span>
                            <match-player v-bind:player="team.playerB"/>
                        </li>
                    `
                });
                Vue.component('interval-match', {
                    props: ['match'],
                    template: `
                        <div class="match card shadow-sm">
                            <div class="card-header">
                                <h5 class="court m-0 font-weight-normal">Court {{ match.court }}</h5>
                            </div>
                            <ul class="list-group list-group-flush">
                                <match-team v-bind:team="match.teamA"></match-team>
                                <match-team v-bind:team="match.teamB"></match-team>
                            </ul>
                        </div>
                    `
                });
                Vue.component('game-interval', {
                    props: ['interval'],
                    template: `
                        <div class="interval text-center col-sm-12 col-md-6 col-lg-6 mb-3 p-2">
                            <h4>{{ interval.date }}</h4>
                            <div class="card-deck">
                                <interval-match v-bind:match="match" v-bind:key="match.court" v-for="match in interval.matches"></interval-match>
                            </div>
                        </div>
                    `
                });

                function getGames() {
                    let url = `${this.host}/games?interval=${this.intervalType}&games=${this.games}&courts=${this.courts}`;
                    url += `&groupA=${this.groupA.join('&groupA=')}`;
                    url += `&groupB=${this.groupB.join('&groupB=')}`;

                    fetch(url, {'mode': 'cors', 'redirect': 'follow'})
                        .then(response => Promise.all([response.ok, response.json()]))
                        .then(function (resp) {
                            let responseOk = resp[0];
                            let jsonBody = resp[1];
                            if (responseOk) {
                                this.updateGames(jsonBody)
                            } else {
                                throw jsonBody;
                            }
                        }.bind(this))
                        .catch(function (error) {
                            this.error = error.message || 'Unknown Error';
                        }.bind(this));
                }

                app = new Vue({
                    el: '#app',
                    data: {
                        intervals: [],

                        host: PROD ? 'https://tennis-api.endpoints.tennis-games.cloud.goog' : 'http://localhost:8080',
                        intervalType: 'WEEKS',
                        games: 21,
                        courts: 2,

                        groupA: ['1', '2', '3', '4'],
                        groupB: ['A', 'B', 'C', 'D'],

                        error: ''
                    },

                    computed: {
                        hasGames: function () {
                            return this.intervals && this.intervals.length > 0;
                        },

                        groupAArea: {
                            get: function () {
                                return this.groupA.join('\n');
                            },
                            set: function (newValue) {
                                this.groupA = newValue.split('\n');
                            }
                        },

                        groupBArea: {
                            get: function () {
                                return this.groupB.join('\n');
                            },
                            set: function (newValue) {
                                this.groupB = newValue.split('\n');
                            }
                        }
                    },

                    methods: {
                        getGames,
                        updateGames: function (games) {
                            this.error = '';
                            console.log(games);
                            this.courts = games.courts;
                            this.intervalType = games.intervalType;
                            this.intervals = games.intervals;
                        },
                        resetGame: function () {
                            this.intervals = [];
                        }
                    }
                });
            });

        </script>
    </head>

    <body>
        <div class="container" id="app">
            <nav class="navbar navbar-light bg-light rounded">
                <a class="navbar-brand" href="#">Tennis Games</a>
                <form class="form-inline my-2 my-lg-0">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="button" v-on:click="resetGame">New game</button>
                </form>
            </nav>

            <div class="jumbotron mt-3" v-if="!hasGames">
                <h1 class="display-4">Grouped doubles match generator</h1>
                <p class="lead">Create a new game schedule</p>
                <form>
                    <div class="row" v-if="error">
                        <div class="col-md-12">
                            <div class="alert alert-danger">{{ error }}</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="games">Games</label>
                        <input type="text" class="form-control" v-model="games" id="games">
                    </div>
                    <div class="form-group">
                        <label for="courts">Courts</label>
                        <input type="text" class="form-control" v-model="courts" id="courts">
                    </div>
                    <div class="form-group">
                        <label for="intervalType">Interval Type</label>
                        <select class="form-control" id="intervalType" v-model="intervalType">
                            <option value="WEEKS">WEEKLY</option>
                            <option value="MONTHS">MONTHLY</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label>Group A</label>
                            <div class="row pb-1" v-for="(player, index) in groupA">
                                <div class="col-md-12">
                                    <input class="form-control" v-model="groupA[index]" placeholder="Player name"/>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Group B</label>
                            <div class="row pb-1" v-for="(player, index) in groupB">
                                <div class="col-md-12">
                                    <input class="form-control" v-model="groupB[index]" placeholder="Player name"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-dark">Players from the same groups will never be together on a team</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-dark" type="button" v-on:click="getGames">Generate</button>
                    </div>
                </form>
            </div>

            <div class="games py-3" v-if="hasGames">
                <div class="row">
                    <game-interval v-bind:interval="interval" v-bind:key="interval.id" v-for="interval in intervals"></game-interval>
                </div>
            </div>

            <footer class="text-muted">
                <div class="container-fluid p-3 p-md-5">
                    <p>Built by Willie (willie scholtz at gmail) for Großmutti</p>
                </div>
            </footer>
        </div>

        <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-analytics.js"></script>

        <script>
            // Your web app's Firebase configuration
            var firebaseConfig = {
                apiKey: "AIzaSyBEniYsMPvsyDSeUm-lUbr74_ZHVxQWPgE",
                authDomain: "tennis-games.firebaseapp.com",
                databaseURL: "https://tennis-games.firebaseio.com",
                projectId: "tennis-games",
                storageBucket: "tennis-games.appspot.com",
                messagingSenderId: "299121723421",
                appId: "1:299121723421:web:8c76e6c078f269cb4adef4",
                measurementId: "G-3K1H9MHTD0"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            firebase.analytics();
        </script>
    </body>
</html>
